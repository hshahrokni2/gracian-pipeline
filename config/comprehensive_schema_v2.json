{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "BRF Comprehensive Extraction Schema v2.0",
  "description": "Enhanced schema with Phase 0 validations - 256 fields (197 base + 59 enhancements)",
  "version": "2.0.0",
  "date_created": "2025-10-16",
  "type": "object",
  "properties": {
    "metadata_agent": {
      "type": "object",
      "properties": {
        "pdf_filename": {"type": "string"},
        "brf_identifier": {"type": "string"},
        "organization_number": {"type": "string", "pattern": "^\\d{6}-\\d{4}$"},
        "organization_name": {"type": "string"},
        "fiscal_year": {"type": "integer", "minimum": 2000, "maximum": 2030}
      },
      "required": ["pdf_filename", "organization_number", "fiscal_year"]
    },

    "property_agent": {
      "type": "object",
      "properties": {
        "lokaler_revenue_2023": {"type": ["integer", "null"], "minimum": 0},
        "lokaler_revenue_2022": {"type": ["integer", "null"], "minimum": 0},
        "lokaler_revenue_percentage": {"type": ["number", "null"], "minimum": 0, "maximum": 100},
        "lokaler_efficiency_multiplier": {"type": ["number", "null"], "minimum": 0},
        "lokaler_dependency_risk_tier": {
          "type": ["string", "null"],
          "enum": ["LOW", "MEDIUM", "MEDIUM-HIGH", "HIGH", null]
        },
        "residential_fee_impact_if_lokaler_lost": {"type": ["number", "null"], "minimum": 0},
        "tomtratt_annual_cost_2023": {"type": ["integer", "null"], "minimum": 0},
        "tomtratt_annual_cost_2022": {"type": ["integer", "null"], "minimum": 0},
        "tomtratt_escalation_percent": {"type": ["number", "null"]},
        "tomtratt_percent_of_operating_costs": {"type": ["number", "null"], "minimum": 0, "maximum": 100},
        "tomtratt_escalation_risk_tier": {
          "type": ["string", "null"],
          "enum": ["NONE", "LOW", "MEDIUM", "HIGH", "EXTREME", null]
        },
        "tomtratt_20year_projection_stable": {"type": ["integer", "null"], "minimum": 0},
        "tomtratt_20year_projection_25pct_escalation": {"type": ["integer", "null"], "minimum": 0},
        "tomtratt_20year_projection_50pct_escalation": {"type": ["integer", "null"], "minimum": 0},
        "tomtratt_20year_projection_100pct_escalation": {"type": ["integer", "null"], "minimum": 0},
        "savings_vs_tomtratt_baseline": {"type": ["integer", "null"], "minimum": 0},
        "savings_vs_tomtratt_20year": {"type": ["integer", "null"], "minimum": 0},
        "structural_advantage_percent": {"type": ["number", "null"], "minimum": 0, "maximum": 100}
      }
    },

    "fees_agent": {
      "type": "object",
      "properties": {
        "fee_increase_count_2023": {"type": ["integer", "null"], "minimum": 0, "maximum": 10},
        "fee_increase_dates": {
          "type": ["array", "null"],
          "items": {"type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}$"}
        },
        "fee_increase_percentages": {
          "type": ["array", "null"],
          "items": {"type": "number", "minimum": 0, "maximum": 100}
        },
        "compound_fee_effect": {"type": ["number", "null"], "minimum": 0},
        "fee_response_classification": {
          "type": ["string", "null"],
          "enum": ["AGGRESSIVE", "REACTIVE", "PROACTIVE", "DISTRESS", null]
        },
        "fee_decision_soliditet": {"type": ["number", "null"], "minimum": 0, "maximum": 100},
        "fee_decision_cash_to_debt": {"type": ["number", "null"], "minimum": 0},
        "fee_stabilization_probability": {"type": ["number", "null"], "minimum": 0, "maximum": 100}
      }
    },

    "loans_agent": {
      "type": "object",
      "properties": {
        "refinancing_risk_tier": {
          "type": ["string", "null"],
          "enum": ["NONE", "MEDIUM", "HIGH", "EXTREME", null]
        },
        "maturity_cluster_date": {
          "type": ["string", "null"],
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
        },
        "maturity_cluster_months": {"type": ["integer", "null"], "minimum": 0, "maximum": 240},
        "maturity_cluster_amount": {"type": ["integer", "null"], "minimum": 0},
        "lender_diversity_score": {"type": ["number", "null"], "minimum": 0, "maximum": 1},
        "interest_rate_scenario_plus1pct": {"type": ["integer", "null"], "minimum": 0},
        "interest_rate_scenario_plus2pct": {"type": ["integer", "null"], "minimum": 0},
        "interest_rate_scenario_plus3pct": {"type": ["integer", "null"], "minimum": 0},
        "affordability_impact_plus1pct": {"type": ["number", "null"], "minimum": 0}
      }
    },

    "energy_agent": {
      "type": "object",
      "properties": {
        "building_age_at_report": {"type": ["integer", "null"], "minimum": 0, "maximum": 200},
        "electricity_reduction_percent": {"type": ["number", "null"]},
        "total_energy_reduction_percent": {"type": ["number", "null"]},
        "energy_reduction_hypothesis": {
          "type": ["string", "null"],
          "enum": ["commissioning", "retrofit", "renovation", "none", null]
        },
        "energy_commissioning_issue_flag": {"type": ["boolean", "null"]},
        "energy_best_practice_flag": {"type": ["boolean", "null"]},
        "energy_measures_implemented": {"type": ["string", "null"]},
        "government_energy_support_2023": {"type": ["integer", "null"], "minimum": 0}
      }
    },

    "key_metrics_agent": {
      "type": "object",
      "description": "NEW AGENT: Financial metrics and depreciation paradox detection",
      "properties": {
        "result_without_depreciation_2023": {"type": ["integer", "null"]},
        "result_without_depreciation_2022": {"type": ["integer", "null"]},
        "depreciation_as_percent_of_revenue_2023": {"type": ["number", "null"], "minimum": 0},
        "depreciation_paradox_flag": {"type": ["boolean", "null"]},
        "depreciation_paradox_cash_flow_quality": {
          "type": ["string", "null"],
          "enum": ["EXCELLENT", "STRONG", "NONE", null]
        },
        "building_age_at_report_calculated": {"type": ["integer", "null"], "minimum": 0},
        "electricity_reduction_calculated": {"type": ["number", "null"]},
        "total_energy_reduction_calculated": {"type": ["number", "null"]}
      }
    },

    "balance_sheet_agent": {
      "type": "object",
      "description": "NEW AGENT: Cash crisis detection and liquidity monitoring",
      "properties": {
        "total_liquidity_2023": {"type": ["integer", "null"], "minimum": 0},
        "total_liquidity_2022": {"type": ["integer", "null"], "minimum": 0},
        "cash_to_debt_ratio_2023": {"type": ["number", "null"], "minimum": 0},
        "cash_to_debt_ratio_2022": {"type": ["number", "null"], "minimum": 0},
        "cash_to_debt_ratio_2021": {"type": ["number", "null"], "minimum": 0},
        "cash_trend": {
          "type": ["string", "null"],
          "enum": ["declining", "stable", "improving", null]
        },
        "cash_crisis_flag": {"type": ["boolean", "null"]},
        "months_to_zero_cash": {"type": ["integer", "null"], "minimum": 0}
      }
    },

    "critical_analysis_agent": {
      "type": "object",
      "description": "NEW AGENT: Pattern classification and composite scoring",
      "properties": {
        "pattern_b_new_flag": {"type": ["boolean", "null"]},
        "interest_rate_victim_flag": {"type": ["boolean", "null"]},
        "aggressive_management_flag": {"type": ["boolean", "null"]},
        "reactive_management_flag": {"type": ["boolean", "null"]},
        "proactive_management_flag": {"type": ["boolean", "null"]},
        "distress_management_flag": {"type": ["boolean", "null"]},
        "lokaler_dual_threshold_flag": {"type": ["boolean", "null"]},
        "management_quality_score": {"type": ["number", "null"], "minimum": 0, "maximum": 100},
        "stabilization_probability": {"type": ["number", "null"], "minimum": 0, "maximum": 100},
        "operational_health_score": {"type": ["number", "null"], "minimum": 0, "maximum": 100},
        "structural_risk_score": {"type": ["number", "null"], "minimum": 0, "maximum": 100}
      }
    }
  },

  "validation_rules": {
    "description": "Field-level validation rules for Phase 0 enhancements",
    "rules": [
      {
        "rule_id": "lokaler_dual_threshold",
        "description": "Lokaler dependency risk tier must match dual threshold logic",
        "logic": "IF (lokaler_area% >= 15 AND lokaler_revenue% >= 30) THEN tier = HIGH",
        "test_case": {
          "pdf_id": "brf_82839",
          "lokaler_area_percentage": 14.3,
          "lokaler_revenue_percentage": 39.3,
          "expected_tier": "MEDIUM-HIGH"
        }
      },
      {
        "rule_id": "fee_classification_thresholds",
        "description": "Fee response classification must match criteria",
        "logic": "IF (single increase >= 20% AND soliditet >= 80% AND cash >= 3%) THEN AGGRESSIVE",
        "test_case": {
          "pdf_id": "brf_83301",
          "fee_increase_percentages": [25.0],
          "fee_decision_soliditet": 82.0,
          "fee_decision_cash_to_debt": 4.4,
          "expected_classification": "AGGRESSIVE"
        }
      },
      {
        "rule_id": "refinancing_risk_tiers",
        "description": "Refinancing risk tier based on kortfristig debt ratio",
        "thresholds": {
          "NONE": "<30%",
          "MEDIUM": "30-50%",
          "HIGH": "50-75%",
          "EXTREME": ">=75%"
        },
        "test_cases": [
          {"kortfristig_ratio": 31.3, "expected_tier": "MEDIUM"},
          {"kortfristig_ratio": 60.6, "expected_tier": "HIGH"},
          {"kortfristig_ratio": 69.5, "expected_tier": "HIGH"}
        ]
      },
      {
        "rule_id": "depreciation_paradox_criteria",
        "description": "Both criteria required (AND, not OR)",
        "logic": "result_without_depreciation >= 500000 AND soliditet >= 85",
        "test_cases": [
          {
            "pdf_id": "brf_82839",
            "result_without_depreciation": 1057000,
            "soliditet": 85,
            "expected_flag": true,
            "expected_quality": "EXCELLENT"
          },
          {
            "pdf_id": "brf_83301",
            "result_without_depreciation": 486000,
            "soliditet": 82,
            "expected_flag": false,
            "expected_quality": "NONE",
            "reason": "486k < 500k OR 82% < 85%"
          }
        ]
      },
      {
        "rule_id": "cash_crisis_criteria",
        "description": "Both criteria required: ratio <2% AND declining trend",
        "logic": "cash_to_debt_ratio < 2.0 AND cash_trend == 'declining'",
        "test_cases": [
          {
            "pdf_id": "brf_83301",
            "cash_to_debt_ratio_2023": 4.4,
            "cash_trend": "improving",
            "expected_flag": false
          }
        ]
      },
      {
        "rule_id": "energy_commissioning_hypothesis",
        "description": "Young building (<10 years) with >30% reduction = commissioning",
        "logic": "building_age < 10 AND electricity_reduction <= -30%",
        "test_case": {
          "pdf_id": "brf_83301",
          "building_age_at_report": 7,
          "electricity_reduction_percent": -36.4,
          "expected_hypothesis": "commissioning",
          "expected_flag": true
        }
      },
      {
        "rule_id": "compound_fee_effect",
        "description": "Compound calculation for multiple increases",
        "formula": "(1 + r1/100) * (1 + r2/100) * ... - 1",
        "example": {
          "increases": [3.0, 15.0],
          "calculation": "(1.03 * 1.15) - 1 = 0.1845",
          "expected_result": 18.45
        }
      },
      {
        "rule_id": "lender_diversity_score",
        "description": "Lender concentration metric",
        "formula": "unique_lenders / total_loans",
        "range": [0.0, 1.0],
        "interpretation": {
          "0.25": "100% concentration (1 lender, 4 loans)",
          "0.75": "Good diversification (3 lenders, 4 loans)",
          "1.0": "Single loan case (1 lender, 1 loan)"
        }
      }
    ]
  },

  "edge_cases": {
    "description": "Critical edge cases for Week 2 validation",
    "cases": [
      {
        "case_id": "pdf42_lokaler_dual_threshold",
        "pdf": "brf_82839",
        "description": "Area 14.3% (below 15% threshold) BUT revenue 39.3% (above 30%)",
        "validation": {
          "lokaler_area_percentage": 14.3,
          "lokaler_revenue_percentage": 39.3,
          "lokaler_efficiency_multiplier": 2.74,
          "expected_lokaler_dependency_risk_tier": "MEDIUM-HIGH",
          "expected_residential_fee_impact_if_lokaler_lost": 64.9
        },
        "critical": true,
        "reason": "Traditional area-only threshold would miss this high-risk dependency"
      },
      {
        "case_id": "pdf43_aggressive_management",
        "pdf": "brf_83301",
        "description": "Single +25% increase with strong balance sheet",
        "validation": {
          "fee_increase_count_2023": 1,
          "fee_increase_percentages": [25.0],
          "fee_response_classification": "AGGRESSIVE",
          "fee_decision_soliditet": 82.0,
          "fee_decision_cash_to_debt": 4.4,
          "expected_fee_stabilization_probability": 75.0
        },
        "critical": true,
        "reason": "Classification logic must distinguish AGGRESSIVE from DISTRESS"
      },
      {
        "case_id": "pdf42_depreciation_paradox",
        "pdf": "brf_82839",
        "description": "Strong cash flow masked by K2 depreciation",
        "validation": {
          "result_without_depreciation_2023": 1057000,
          "soliditet_2023": 85,
          "expected_depreciation_paradox_flag": true,
          "expected_depreciation_paradox_cash_flow_quality": "EXCELLENT"
        },
        "critical": true,
        "reason": "Both criteria must be met (AND logic, not OR)"
      },
      {
        "case_id": "pdf43_paradox_near_miss",
        "pdf": "brf_83301",
        "description": "486k cash flow (4% short) OR 82% soliditet (3pp short)",
        "validation": {
          "result_without_depreciation_2023": 486000,
          "soliditet_2023": 82,
          "expected_depreciation_paradox_flag": false,
          "expected_depreciation_paradox_cash_flow_quality": "NONE"
        },
        "critical": true,
        "reason": "Near-miss validation - thresholds must be enforced strictly"
      }
    ]
  },

  "prevalence_rates": {
    "description": "Expected extraction prevalence for validation (from 43-PDF corpus)",
    "rates": {
      "tier_1_universal": {
        "loans_agent_refinancing": {"expected": "100%", "count": "43/43"},
        "fee_response_classifier": {"expected": "100%", "count": "43/43"}
      },
      "tier_2_common": {
        "property_agent_lokaler": {"expected": "25.6%", "count": "11/43"},
        "fees_multiple": {"expected": "18.6%", "count": "8/43"}
      },
      "tier_3_selective": {
        "energy_bidirectional": {"expected": "14.0%", "count": "6/43"},
        "tomtratt_escalation": {"expected": "16.3%", "count": "7/43"}
      },
      "tier_4_rare": {
        "depreciation_paradox": {"expected": "4.7%", "count": "2/43"},
        "cash_crisis": {"expected": "2.3%", "count": "1/43"}
      },
      "patterns": {
        "pattern_b_new": {"expected": "16.3%", "count": "7/43"},
        "aggressive_management": {"expected": "20.9%", "count": "9/43"},
        "lokaler_dual_threshold": {"expected": "7.0%", "count": "3/43"}
      }
    }
  },

  "success_criteria": {
    "description": "Week 2 validation success criteria",
    "criteria": {
      "field_extraction": {
        "description": "All 59 new fields extracting correctly",
        "target": "100%",
        "validation": "No null fields where data exists in PDF"
      },
      "enhancement_accuracy": {
        "description": "Enhancement logic working as specified",
        "target": ">=95%",
        "validation": "Edge cases + random sample validation"
      },
      "edge_case_validation": {
        "description": "All 4 critical edge cases passing",
        "target": "4/4 (100%)",
        "cases": [
          "pdf42_lokaler_dual_threshold",
          "pdf43_aggressive_management",
          "pdf42_depreciation_paradox",
          "pdf43_paradox_near_miss"
        ]
      },
      "prevalence_match": {
        "description": "Actual extraction prevalence matches manual analysis",
        "target": "0% variance",
        "validation": "Compare auto-extraction counts with manual corpus analysis"
      },
      "no_blocking_bugs": {
        "description": "No P0 or P1 bugs remaining",
        "target": "0 blocking issues",
        "validation": "Bug tracker shows all P0/P1 resolved"
      }
    }
  },

  "version_history": {
    "v1.0": {
      "date": "2025-PDFs 1-15",
      "fields": 197,
      "description": "Initial schema with 98% declared saturation"
    },
    "v2.0": {
      "date": "2025-10-16",
      "fields": 256,
      "added": 59,
      "description": "Phase 0 enhancements from PDFs 16-43 discoveries",
      "changes": [
        "Added lokaler revenue tracking (6 fields)",
        "Added fee response classification (8 fields)",
        "Added refinancing risk assessment (9 fields)",
        "Added depreciation paradox detection (5 fields)",
        "Added cash crisis monitoring (8 fields)",
        "Added energy efficiency analysis (8 fields)",
        "Added tomtr√§tt analysis (13 fields)",
        "Added pattern flags (7 fields)",
        "Added quantitative scores (4 fields)",
        "Created 3 new agent types (key_metrics, balance_sheet, critical_analysis)"
      ]
    }
  }
}
